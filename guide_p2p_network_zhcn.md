This file is licensed under the [MIT License (MIT)](http://opensource.org/licenses/MIT) available on http://opensource.org/licenses/MIT.

[对应英文文档](https://github.com/bitcoin-dot-org/bitcoin.org/blob/master/_includes/devdoc/guide_p2p_network.md)

# P2P网络
比特币网络协议允许全节点（peers）之间协作地维护一个区块和交易交换的p2p网络。全节点在把转发前先校验每个区块和交易。归档节点市值可以存储整个区块链的区块链并可以为其他节点提供历史区块的全节点。剪枝节点是是不保存整个区块链的全节点。许多客户端通常使用比特币网络协议与全节点相连。

一致性协议并不包括网络校验，因此比特币程序可以调整网络和协议，比如一些矿工使用的高速区块交换网络、一些为钱包提供SPV级别安全的专门交易信息服务器等。

为了为比特币p2p网络提供一个使用的例子，本节当中使用比特币核心作为全节点的代表，BitcoinJ作为SPV客户端代表。这两个程序功能都是弹性的，因此这里只介绍基本功能。同时，出于隐私考虑，例子中出现的IP地址使用保留IP代替。

## 伙伴发现
第一次启动时，程序不知道任何的存活节点。为了发现一些IP地址，他们查询一个或多个在比特币核心和BitcoinJ程序中硬编码的DNS名字（称为DNS种子）。查询的结果将会包含一个或多个 DNS A记录，这些A记录会伴随一些可能接受新连接的全节点IP地址。比如，使用`dig`命令：
```
;; QUESTION SECTION:
;seed.bitcoin.sipa.be.	    IN  A

;; ANSWER SECTION:
seed.bitcoin.sipa.be.	60  IN  A  192.0.2.113
seed.bitcoin.sipa.be.	60  IN  A  198.51.100.231
seed.bitcoin.sipa.be.	60  IN  A  203.0.113.183
[...]
```

DNS种子由比特币社区的成员维护：一些人提供动通过扫描网络自动获取活跃IP地址的动态DNS种子服务器，一些人提供静态手动更新的可能不太活跃的IP的DNS种子。在一些情况下，在指定主网络端口8333或测试网络端口18333运行的节点会被自动加入DNS种子当中。

由于DNS种子不是权威认证的，一些恶意种子提供者或网络中间人攻击可能只返回被攻击者控制的种子，从而把程序孤立在攻击者自己的网络中，以此来发起伪造协议和区块。由于这些原因，程序不能完全只依靠DNS种子。

一旦一个程序接入网络中，它的伙伴就开始向它发送`addr`（地址）信息，其中个那些带了网络当中其他伙伴的端口和地址，提供了一种完全区中心的伙伴发现方法。比特币核心把当前已知的伙伴持久化保存在一个磁盘数据库当中，后面的启动中通常直接连接到这些伙伴而不再使用DNS种子。

但是，经常有伙伴离开网络或改变IP地址，因此程序可能启动前再一次成功的连接前发起多次尝试。这会为程序引入较大的延迟才能接入网络，迫使用户在发送交易或校验支付状态时等待很久。

为了避免这种可能的延迟，对于刚激活的节点，BitcoinJ通常使用动态DNS种子获取IP地址。比特币核心通常试图在最小化延迟和避免使用多余的DNS种子使用之间达到一个平衡：如果比特币核心在它的伙伴数据库当中有相应的记录，在使用种子前，它最多花费11s尝试连接至少一个伙伴；如果在这段时间内建立起一个连接，就不需要查询任何种子了。

比特币核心和BitcoinJ都包含一个硬编码的IP和端口列表，它们指向对应版本第一次发布时点附近活跃的节点。比特币核心在所有的DNS种子服务器在60s内没有响应时将开始尝试区连接到这些节点，提供一个自动的后备选项。

对于手动后备选项，比特币核心也提供了几个命令行连接选项，包括从通过IP指定的节点链接到一系列伙伴，或和某个通过IP指定的固定的节点维持一个持续连接。使用`-help`参数查看文本帮助信息。BitcoinJ也可以编程支持同样的操作。

资源：Bitcoin Seeder，该程序运行在比特币核心和BitcoinJ使用的种子服务器上。比特币核心DNS Seed Policy。比特币核心和BitcoinJ使用的硬编码的IP地址使使用makeseeds脚本产生的。

## 连接伙伴
连接是通过发送一个`version`信息到远端节点实现的，其中包括版本号、区块、当前时间。远端节点使用自己的版本信息回复。这样两个节点相互发送一个`verack`信息证实连接已经建立。

一旦建立连接，本地节点就可以向远端节点发送`getaddr`和`addr`信息获取更多的伙伴。

为了维护和伙伴的连接，节点默认在30分钟连接失效前向伙伴节点发送一条信息。如果90分钟内都没有收到一个伙伴的信息，节点就会假定伙伴的连接已经关闭。

## 初始区块下载
在一个全节点有能力校验一个未确认交易和最近新挖区块前，他必须下载并校验从第1个区块（硬编码的创始区块之后）开始到当前最优（可能存在分叉）区块链的所有区块。这被成为IBD（初始区块下载，Initial Block Download）或初始同步。

尽管“初始”这个词暗示这个过程只执行一次，但在任何时候有大量区块下载时候也都会使用它，比如之前接入的节点已经离线很久。这种情况下，节点可以使用IBD方式下载从它上次离线到现在的所有区块。




### 区块优先



### 块头优先


## 区块广播

## 交易广播

## 异常节点

## 警告
